name: Deploy to Oracle Cloud

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: opc
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /var/www/dharaniWeb
            
            # Install PM2 locally if not present
            if not test -e node_modules/pm2
                npm install pm2 --save
            end
            
            # Create ecosystem.config.js if it doesn't exist
            if not test -e ecosystem.config.js
                echo 'module.exports = {
                  apps: [{
                    name: "dharaniWeb",
                    script: "./server.js",
                    watch: true,
                    env: {
                      NODE_ENV: "production",
                      PORT: 5000
                    },
                    max_memory_restart: "500M"
                  }]
                }' > ecosystem.config.js
            end
            
            git pull origin master
            
            if test -e package.json
                npm install
            end
            
            # Use the local PM2 from node_modules
            if ./node_modules/.bin/pm2 list | grep -q "dharaniWeb"
                ./node_modules/.bin/pm2 restart ecosystem.config.js
            else
                ./node_modules/.bin/pm2 start ecosystem.config.js
                ./node_modules/.bin/pm2 save
            end
            
            # Check nginx config before restarting
            sudo nginx -t && sudo systemctl restart nginx || (echo "Nginx failed to restart. Checking logs..." && sudo journalctl -xe -u nginx.service)